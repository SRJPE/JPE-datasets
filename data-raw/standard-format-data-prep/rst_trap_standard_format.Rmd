---
title: "Create standard format for RST trap operations data"
output: html_document
---

```{r, include = F}
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(knitr)
library(hms)  
library(EDIutils)
root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
```

```{r, include = F}
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
```


## RST Trap Operations Data Standardization

Data were checked and cleaned in scripts available [here](https://github.com/FlowWest/JPE-datasets/tree/main/scripts/rst)

FlowWest received trap operations data from 9 monitoring programs: 

-   Battle Creek
-   Butte Creek
-   Clear Creek
-   Deer Creek
-   Feather River
-   Mill Creek
-   Knights Landing
-   Yuba River
-   Tisdale (and Lower Feather River)
-   Red BLuff Diversion Dam

## Standard format for RST Trap Operations Data

Data dictionary for standard format:

(B - Battle Creek, Bu - Butte Creek, C - Clear Creek, F - Feather River,
D - Deer Creek, M - Mill Creek, KL - Knights Landing,
T - Tisdale, Y - Yuba River)

| column name   | stream collects         | definition                                               |
|:-----------------|:-------------------|:---------------------------------|
| trap_visit_id      | B, C, F, KL, T | This primary key is used to link with the catch table. Monitoring programs using CAMP have trap_visit_id as well as Battle and Clear.                      |
| stream      | B, Bu, C, D, F, M, KL, T, Y | Which stream the RST is located on                       |
| site          | B, Bu, C, D, F, M, KL, T, Y | Site name                                                |
| subsite       | B, Bu, C, F, Y, KL, T          | Name of trap                                |
| trap_visit_date          | B, Bu, C, D, F, M, KL, T, Y | Date that trap was visited. This field is included because in some cases a visit will not have a start/stop time (e.g. if trap was cleaned/serviced or just checked)                             |
| trap_visit_time     | B, Bu, C, D, F, M, KL, T, Y           | Time that trap was visited. |
| trap_start_date          | B, Bu, C, D, F, M, KL, T, Y               | Date that trap was started prior to being sampled. trap_start_date and trap_stop_date are meant to describe the sampling period.                                             |
| trap_start_time  | B, Bu, C, D, F, M, KL, T, Y      | Time that trap was started prior to being sampled.                  |
| trap_stop_date | | Date that trap was sampled. trap_start_date and trap_stop_date are meant to describe the sampling period. If fish were not processed there will not be a trap_stop_date. |
| trap_stop_time | | Time that trap was sampled. |
| visit_type | Bu, F, KL, T, Y | Describes the trap visit type. Categories: start trapping, continue trapping, unplanned restart, end trapping, service trap, drive by. If visit_type is not used, "not recorded" is entered. |
| trap_functioning | B, C, D, F, M, KL, T | Describes how well trap is functioning. Categories: trap functioning normally, trap stopped functioning, trap not in service, trap functioning but not normally. If trap_functioning not used, "not recorded" is entered. |
| fish_processed | F, KL, T | Describes if fish were processed. Categories: processed fish; no fish caught; no catch data, fish released; no catch data, fish left in live box. If fish_processed not used, "not recorded" is entered. |
| gear_type | Bu, Y | Describes the type of gear used. For most locations, a rotary screw trap is used 100% of the time. For Butte and Yuba, a diversion trap may be used some of the time. This field can be used to find sample periods when a diversion trap is being used. For clarity, "rotary screw trap" was filled in for all other locations. |
| in_thalweg | B, C, F, KL, T | Boolean to describe if trap fished in thalweg. If not recorded, then assumed to be TRUE. |
| partial_sample | B, C, KL | Boolean to describe if partial sample (e.g. half of traps fished or half of sampling period. If not recorded, then assumed to be FALSE. |
| is_half_cone_configuration | B, C, F, KL, T | Boolean to describe if trap fished in half cone configuration. If not recorded, then assumed to be FALSE. |
| depth_adjust | B, C | Depth of the bottom of the cone of trap (centimeter). If not recorded, then NA. |
| debris_volume | B, C | Volume of debris emptied from trap (gallons). If not recorded, then NA. |
| debris_level | F, KL, T, Y | Describes the level of debris emptied from trap. Categories: none, light, medium, heavy, very heavy. If not used, "not recorded" is entered. |
| rpms_start | B, Bu, C, D, F, M, KL, T, Y | Revolutions per minute at the start of the trap visit before trap is cleaned. If not recorded, then NA. | 
| rpms_end | Bu, F, KL, T, Y | Revolutions per minute at the end of the trap visit after trap is cleaned. If not recorded, then NA. |
| counter_start | F, KL, T | Revolutions on counter at start of trap visit. If not recorded, then NA. |
| counter_end | F, KL, T | Revolution on counter at end of trap visit. If not recorded, then NA. |
| sample_period_revolutions | B, Bu, C, KL, Y | Revolutions during sample period. If not recorded, then NA. |
| include | F, KL, T | Boolean to describe if sample should be included in data for analysis. If false then data or visit is determined to be of poor quality by data steward and should not be included in analysis. If not recorded, then assumed to be TRUE. |
| comments | B, C, F, KL, T, Y | Qualitative comments about trap visit. |

```{r, data_pull, include = F}
# Data pulled in from google cloud in rst_catch_standard_format
# load in data
gcs_get_object(object_name = "rst/rbdd/data/trap.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/rst/rbdd_trap.csv",
               overwrite = TRUE)
# catch data
battle_clear_rst <- read_csv(here::here("data", "rst", "battle_clear_catch_edi.csv"))
butte_rst <- read_csv(here::here("data", "rst", "butte_rst.csv")) # contains trap data too
deer_rst <- read_csv(here::here("data", "rst", "deer_rst.csv")) # contains trap data too
feather_rst <- read_csv(here::here("data", "rst", "feather_rst.csv"))
feather_rst_camp <- read_csv(here::here("data", "rst", "feather_catch_camp.csv"))
knights_landing_rst <- read_csv(here::here("data", "rst", "knights_catch_camp.csv"))
knights_landing_pre2006 <- read_csv(here::here("data", "rst", "knights_combine_rst_clean.csv"))
tisdale_rst_camp <- read_csv(here::here("data", "rst", "tisdale_rst_catch_camp.csv"))
mill_rst <- read_csv(here::here("data", "rst", "mill_rst.csv")) # contains trap data too
yuba_rst <- read_csv(here::here("data", "rst", "yuba_rst.csv"))
rbdd_rst <- read_csv(here::here("data", "rst", "rbdd_rst.csv"))

# sampling effort and environmental
battle_clear_trap <- read_csv(here::here("data", "rst", "battle_clear_trap_edi.csv"))
battle_clear_environmental <- read_csv(here::here("data", "rst", "battle_clear_environmental_edi.csv"))
butte_trap_camp <- read_csv(here::here("data", "rst", "butte_trap_camp.csv"))
feather_effort <- read_csv(here::here("data", "rst", "feather_rst_effort.csv"))
feather_trap_camp <- read_csv(here::here("data", "rst", "feather_trap_camp.csv"))
knights_effort <- read_csv(here::here("data", "rst", "knights_trap_camp.csv"))
knights_effort_pre2006 <- read_csv(here::here("data", "rst", "knights_combine_sampling_effort_clean.csv"))
knight_trap_pre2002 <-  read_csv(here::here("data", "rst", "knights_2002_trap.csv"))
tisdale_trap_camp <- read_csv(here::here("data", "rst", "tisdale_rst_trap_camp.csv"))
rbdd_trap <- read_csv(here::here("data", "rst", "rbdd_trap.csv"))
```

# Data formatting {.tabset}

## Battle & Clear Creek

```{r, battle_clean}

battle_clear_trap_clean <- battle_clear_trap |> 
  # removes entries with missing site
  filter(!is.na(stream)) |> 
  mutate(trap_start_date1 = trap_start_date,
         trap_start_date = case_when(trap_stop_date < trap_start_date ~ trap_stop_date,
                                     T ~ trap_start_date),
         trap_stop_date = case_when(trap_stop_date < trap_start_date ~ trap_start_date1,
                                    T ~ trap_stop_date)) |> 
  select(-trap_start_date1)
unique(battle_clear_trap_clean$stream)

# issues with trap start and stop date
ck <- battle_clear_trap_clean |> 
  mutate(diff = as.numeric(trap_stop_date - trap_start_date)) |> 
  filter(diff > 7 | diff < -7)
#filter(battle_clear_trap_clean, trap_stop_date < trap_start_date)
```

### Variables removed

- baileys_eff and report_baileys_eff are calculated values
- num_released included in mark and recapture data
- sub_week: is related to efficiency and included in efficiency table
- sample_weight: same as cone variable
- flow_start_meter, flow_end_meter, flow_set_time, velocity, turbidity,
weather_code, lunar_phase, diel included in environmental table
- river_left_depth, river_center_depth, river_right_depth removed because they should be included in the environmental table rather than trap. 
- habitat removed because most data are in "run"
- debris_type removed because data does not exist for other locations and is treated like a comments field
- start_counter is always NA or 0. No meaningful data.
- trap_sample_type - 3666 non-intensive, 57 random. we do not know what encodings mean and almost all are non-intensive
- trap_fishing and fish_properly do not offer new information from gear_condition

Note that sample_id was renamed to trap_visit_id for clarity and links to catch and environmental data.

partial_sample and cone_setting are both about effort but cone_setting refers to half/full cone and partial_sample is about the amount of time sampled.

## Butte Creek

```{r, butte_clean}
unique(butte_rst$trap_status)
unique(butte_rst$gear_id)
unique(butte_rst$station)
butte_rst %>%
  group_by(station, gear_id) %>%
  tally()

butte_trap_camp %>%
  group_by(siteName, subSiteName) %>%
  tally()

# there are multiple obs per day which i think is a data entry issue.
# group by date, station, time, gear_id, trap_status then average
butte_trap_clean_pre_2015 <- butte_rst %>% 
  select(-c(dead, count, fork_length, weight, mark_code, lifestage,
            weather, temperature, turbidity, secchi, velocity)) %>%
  group_by(date, station, trap_status, time, gear_id) %>%
  # summarized because pulling from rst data which is row per fish
  summarize(trap_revolutions = mean(trap_revolutions, na.rm = T),
            rpms_start = mean(rpms_start, na.rm = T),
            rpms_end = mean(rpms_end, na.rm = T)) %>%
  rename(site = station,
         sample_period_revolutions = trap_revolutions,
         trap_stop_date = date,
         trap_stop_time = time) %>%
  mutate(stream = "butte creek",
         subsite = ifelse(gear_id == "diversion fyke trap 1", "okie dam fyke trap", tolower(site)), 
         site = case_when(grepl("Okie Dam", site) ~ "okie dam",
                          T ~ tolower(site)),
         sample_period_revolutions = ifelse(is.nan(sample_period_revolutions), NA, sample_period_revolutions),
         rpms_start = ifelse(is.nan(rpms_start), NA, rpms_start),
         rpms_end = ifelse(is.nan(rpms_end), NA, rpms_end)) %>%
  distinct() %>%
  select(-gear_id)


butte_trap_clean_camp <- butte_trap_camp %>% 
    select(-c(debrisVolumeCat, debrisVolume, debrisVolumeUnits)) %>%
  mutate(
    stream = "butte creek",
    site = "okie dam",
    # Only fish at okie dam now - also refered to as parot-phelan
    subsite = ifelse(subSiteName == "PP RST", "okie dam 1", "okie dam fyke trap"),
    trap_visit_date = as.Date(visitTime),
    trap_visit_time = as_hms(visitTime),
    trap_stop_date = case_when(
      visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as.Date(visitTime),
      T ~ as.Date(NA)
    ),
    trap_stop_time = case_when(
      visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as_hms(visitTime),
      T ~ as_hms(NA)
    ),
    trap_start_date = case_when(
      visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") |
        (
          fishProcessed == "Processed fish" &
            visitType != "Start trap & begin trapping"
        ) ~ as.Date(lag(visitTime2)),
      T ~ as.Date(NA)
    ),
    trap_start_time = case_when(
      visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") |
        (
          fishProcessed == "Processed fish" &
            visitType != "Start trap & begin trapping"
        ) ~ as_hms(lag(visitTime2)),
      T ~ as_hms(NA)
    ),
    diff = as.numeric(trap_stop_date - trap_start_date),
    # logic to assign trap_start_date based on the last stop date does not always work so assume 1 day less
    trap_start_date = case_when(diff > 7 | diff < -7 ~ as_date(trap_stop_date - 1),
                                T ~ trap_start_date)
  ) %>% 
  rename(trap_visit_id = trapVisitID,
         rpms_start = rpmRevolutionsAtStart,
         rpms_seconds_start = rpmSecondsAtStart,
         rpms_end = rpmRevolutionsAtEnd,
         rpms_seconds_end = rpmSecondsAtEnd,
         counter_start = counterAtStart,
         counter_end = counterAtEnd,
         trap_status = visitType,
         fish_processed = fishProcessed,
         gear_condition_code = trapFunctioning,
         is_half_cone_configuration = halfCone,
         in_thalweg = inThalweg,
         include = includeCatch) %>%
  select(-c(subSiteName, siteName, visitTime, visitTime2, projectDescriptionID, diff)) %>% 
   mutate(trap_visit_id = as.character(trap_visit_id),
         in_thalweg = case_when(in_thalweg == "Yes" ~ T, 
                                in_thalweg == "No" ~ F,
                                T ~ as.logical(NA)),
         include = case_when(include == "Yes" ~ T, 
                                include == "No" ~ F,
                                T ~ as.logical(NA)),
         is_half_cone_configuration = case_when(is_half_cone_configuration == "Yes" ~ T, 
                                is_half_cone_configuration == "No" ~ F,
                                T ~ as.logical(NA)),
         trap_status = tolower(trap_status),
         fish_processed = tolower(fish_processed),
         gear_condition_code = tolower(gear_condition_code)) %>%
  distinct() %>% glimpse()

  
  
butte_trap_clean_unfiltered <- bind_rows(butte_trap_clean_pre_2015, butte_trap_clean_camp)

# find all dates that a trap that is not okie dam fyke trap is running
keep_dates <- butte_trap_clean_unfiltered %>% 
  filter(subsite != "okie dam fyke trap") %>% 
  pull(trap_stop_date)

# check to make sure one row per day/time 
# butte_trap_clean %>%
#   group_by(date, time, site, gear_id, trap_status) %>%
#   tally() %>%
#   filter(n > 1)

# Filter out days that only fyke is running 
butte_trap_clean <- 
  butte_trap_clean_unfiltered %>% 
  filter(trap_stop_date %in% keep_dates) %>% 
  mutate(trap_start_date1 = trap_start_date,
         trap_start_date = case_when(trap_stop_date < trap_start_date ~ trap_stop_date,
                                     T ~ trap_start_date),
         trap_stop_date = case_when(trap_stop_date < trap_start_date ~ trap_start_date1, 
                                 T ~ trap_stop_date)) |> 
  select(-trap_start_date1) |> 
  glimpse()

# no issues with trap start and stop date
ck <- butte_trap_clean |> 
  mutate(diff = as.numeric(trap_stop_date - trap_start_date)) |> 
  filter(diff > 7 | diff < -7)

unique(butte_trap_clean$site)
unique(butte_trap_clean$subsite)

filter(butte_trap_clean, trap_stop_date < trap_start_date)
```

### Variables removed

All variables removed are included in the catch table or environmental table.

- gear_id removed because the subsite provided information about the gear

Some subsites are NA, especially in the first few years. It would be good to better understand what is going on with these data gaps. 

## Deer Creek

```{r, deer_clean}
unique(deer_rst$location)

deer_rst %>%
  filter(year(date) > 1995) %>%
  group_by(location) %>%
  tally()
unique(deer_rst$trap_condition_code)

deer_trap_clean <- deer_rst %>% 
  select(-c(count, fork_length, weight,
            flow, turbidity, weather, water_temperature_celsius)) %>%
  group_by(date, trap_condition_code) %>%
  summarize(time_for_10_revolutions = mean(time_for_10_revolutions, na.rm = T)) %>%
  ungroup() %>%
  rename(gear_condition_code = trap_condition_code,
         trap_stop_date = date) %>%
  mutate(stream = "deer creek",
         site = stream,
         subsite = site,
         # transforming to rpms_start to align with other locations
         rpms_start = case_when(is.na(time_for_10_revolutions) ~ as.numeric(NA),
                                time_for_10_revolutions == 0 ~ 0,
                                T ~ 60/(time_for_10_revolutions/10))) %>%
  select(-time_for_10_revolutions) %>%
  distinct()


# check to make sure one row per day/time 
# deer_trap_clean %>%
#   group_by(date,site, trap_condition_code) %>%
#   tally() %>%
#   filter(n > 1)
# 
# filter(deer_trap_clean, date == "2001-11-10")
deer_trap_clean %>% glimpse
# deer only has stop date

```

We will be handling data updates for Deer and Mill through DataTackle but 2021-2023 need to be added to historical data because they are not handled by DataTackle. The 2023-2024 season and forward will be handled by DataTackle.

```{r}
res <- read_data_entity_names(packageId = "edi.1504.3")
raw <- read_data_entity(packageId = "edi.1504.3", entityId = res$entityId[4])
deer_mill_trap_raw <- read_csv(file = raw)

new_deer_trap <- deer_mill_trap_raw |> 
  filter(stream == "deer creek", date > max(deer_trap_clean$trap_stop_date)) |> 
  rename(trap_stop_date = date,
         rpms_start = rpm_before,
         rpms_end = rpm_after,
         gear_condition_code = trap_condition,
         debris_volume = debris_gal) |> 
  mutate(site = stream,
         subsite = site,
         trap_stop_time = as_hms(trap_stop_date),
         trap_stop_date = as_date(trap_stop_date)) |> 
  select(-c(weather, turbidity, water_temperature))

deer_trap_clean_combined <- bind_rows(deer_trap_clean,
                                      new_deer_trap)
```


### Variables removed

All variables removed are included in the catch table or environmental table.

- transformed time_for_10_revolutions to avg_time_per_rev to align with others

## Feather River

```{r, feather_clean}
filter(feather_trap_camp, !is.na(counterAtStart))
filter(feather_trap_camp, !is.na(counterAtEnd))
filter(feather_trap_camp, !is.na(rpmRevolutionsAtStart))
filter(feather_trap_camp, !is.na(rpmRevolutionsAtEnd))
filter(feather_trap_camp, inThalweg == "Yes")
filter(feather_trap_camp, !is.na(debrisVolumeCat))
# only a few cases where visitTime != visitTime2
filter(feather_trap_camp, visitTime != visitTime2)

feather_trap_clean <- feather_trap_camp %>%
  select(-c(debrisVolumeCat, debrisVolume, debrisVolumeUnits)) %>%
  group_by(siteName, subSiteName) %>% 
  arrange(visitTime) %>% 
  mutate(stream = "feather river",
         subsite = tolower(subSiteName),
         site = tolower(siteName),
         trap_visit_date = as.Date(visitTime),
         trap_visit_time = as_hms(visitTime),
         trap_stop_date = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as.Date(visitTime),
                                      T ~ as.Date(NA)),
         trap_stop_time = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as_hms(visitTime),
                                      T ~ as_hms(NA)),
         trap_start_date = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") | (fishProcessed == "Processed fish" & visitType != "Start trap & begin trapping") ~ as.Date(lag(visitTime)),
                                     T ~ as.Date(NA)),
         trap_start_time = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") | (fishProcessed == "Processed fish" & visitType != "Start trap & begin trapping") ~ as_hms(lag(visitTime)),
                                     T ~ as_hms(NA))) %>%
  rename(trap_visit_id = trapVisitID,
         rpms_start = rpmRevolutionsAtStart,
         rpms_seconds_start = rpmSecondsAtStart,
         rpms_end = rpmRevolutionsAtEnd,
         rpms_seconds_end = rpmSecondsAtEnd,
         counter_start = counterAtStart,
         counter_end = counterAtEnd,
         trap_status = visitType,
         fish_processed = fishProcessed,
         gear_condition_code = trapFunctioning,
         is_half_cone_configuration = halfCone,
         in_thalweg = inThalweg,
         include = includeCatch) %>%
  ungroup() %>% 
  select(-c(subSiteName, siteName, visitTime, visitTime2, projectDescriptionID)) %>% 
   mutate(trap_visit_id = as.character(trap_visit_id),
         in_thalweg = case_when(in_thalweg == "Yes" ~ T, 
                                in_thalweg == "No" ~ F,
                                T ~ as.logical(NA)),
         include = case_when(include == "Yes" ~ T, 
                                include == "No" ~ F,
                                T ~ as.logical(NA)),
         is_half_cone_configuration = case_when(is_half_cone_configuration == "Yes" ~ T, 
                                is_half_cone_configuration == "No" ~ F,
                                T ~ as.logical(NA)),
         trap_status = tolower(trap_status),
         fish_processed = tolower(fish_processed),
         gear_condition_code = tolower(gear_condition_code),
         # fix typos
        trap_stop_time = case_when(is.na(trap_stop_time) ~ trap_visit_time,
                                   T ~ trap_stop_time),
        trap_stop_date = case_when(is.na(trap_stop_date) ~ trap_visit_date,
                                   T ~ trap_stop_date)) %>%
  distinct() %>% glimpse()

# # check to make sure one row per day/time 
# there are multiple rows because time is not captured but trap may be checked multiple times a day
ck <- feather_trap_clean %>%
  group_by(trap_stop_date, subsite, trap_status) %>%
  tally()
filter(ck, n > 1)
filter(feather_trap_clean, trap_stop_date == "2000-03-13")
# should not be processing fish during "Service/adjust/clean trap"
filter(feather_trap_clean, fish_processed == "processed fish", is.na(trap_start_date))

# no issues with trap start and stop date
ck <- feather_trap_clean |> 
  mutate(diff = as.numeric(trap_stop_date - trap_start_date)) |> 
  filter(diff > 7 | diff < -7)
```

### Variables removed

All variables removed are included in the location table or environmental table.

## Mill Creek

```{r, mill_clean}
unique(mill_rst$location)
unique(mill_rst$trap_condition_code)

mill_trap_clean <- mill_rst %>%
  select(-c(count, fork_length, weight, location,
            flow, water_temperature, turbidity, weather)) %>%
  group_by(date, trap_condition_code) %>%
  summarize(time_for_10_revolutions = mean(time_for_10_revolutions, na.rm = T)) %>%
  rename(gear_condition_code = trap_condition_code,
         trap_stop_date = date) %>%
  mutate(stream = "mill creek",
         site = stream,
         subsite = site,
         # transforming to rpms_start to align with other locations
         rpms_start = case_when(is.na(time_for_10_revolutions) ~ as.numeric(NA),
                                time_for_10_revolutions == 0 ~ 0,
                                T ~ 60/(time_for_10_revolutions/10))) %>%
  select(-time_for_10_revolutions) %>%
  distinct()

# check to make sure one row per day/time 
# mill_trap_clean %>%
#   group_by(date,site, trap_condition_code) %>%
#   tally() %>%
#   filter(n > 1)
# filter(mill_trap_clean, date == "2002-02-07")
mill_trap_clean %>% glimpse
# mill only has stop date
```

### Variables removed

- location: all are Mill Creek RSTR
- flow, water_temperature, turbidity, weather in environmental table
- transformed time_for_10_revolutions to avg_time_per_rev to align with others

All other removed variables included in the catch table.

```{r}
new_mill_trap <- deer_mill_trap_raw |> 
  filter(stream == "mill creek", date > max(mill_trap_clean$trap_stop_date)) |> 
  rename(trap_stop_date = date,
         rpms_start = rpm_before,
         rpms_end = rpm_after,
         gear_condition_code = trap_condition,
         debris_volume = debris_gal) |> 
  mutate(site = stream,
         subsite = site,
         trap_stop_time = as_hms(trap_stop_date),
         trap_stop_date = as_date(trap_stop_date)) |> 
  select(-c(weather, turbidity, water_temperature))

mill_trap_clean_combined <- bind_rows(mill_trap_clean,
                                      new_mill_trap)
```

## Yuba River

```{r, yuba_clean}
unique(yuba_rst$method)
unique(yuba_rst$trap_status)
unique(yuba_rst$location)

ck <- yuba_rst %>%
  group_by(location, year(date)) %>%
  tally()

check <- yuba_rst %>%
  mutate(diff = trap_revolutions - trap_revolutions2)

yuba_trap_clean <- yuba_rst %>% 
  select(-c(organism_code, fork_length, weight, lifestage, count, run,
            temperature, turbidity, velocity)) %>%
  rename(site = location,
         rpms_start = rpms_before,
         rpms_end = rpms_after,
         trap_stop_date = date,
         trap_stop_time = time,
         debris_level = debris,
         gear_type = method) %>%
  mutate(stream = "yuba river",
         subsite = case_when(site == "Yuba River" ~ "hal", # assume the Yuba River ones are hal. it should not matter too much.
                             site == "5 foot RST at Hallwood" ~ "hal3",
                             site == "RST 1 at Hallwood on Yuba River" ~ "hal",
                             site == "RST 2 at Hallwood" ~ "hal2"),
         site = "hallwood", # there are some cases where location is "Yuba River" Casey Campos said via email to Ashley Vizek that these should be Hallwood
         
         sample_period_revolutions = case_when(trap_revolutions == 0 ~ trap_revolutions2,
                                               T ~ trap_revolutions),
         trap_stop_date = as_date(trap_stop_date),
         debris_level = tolower(debris_level)) %>%
  select(-c(trap_revolutions, trap_revolutions2)) %>%
  distinct()

# check to make sure one row per day/time 
# yuba_trap_clean %>%
#   group_by(date,time, site) %>%
#   tally() %>%
#   filter(n > 1)
yuba_trap_clean %>% glimpse
# yuba only has stop date
```

### Variables removed

All variables removed are included in the catch table or environmental table.

TODO: confirm handling of trap_revolutions and trap_revolutions2 

## Lower Sacramento - Knights Landing

```{r, knights_clean}
unique(knights_effort_pre2006$gear)
unique(knights_effort_pre2006$cone_sampling_effort)
# date, start_date, stop_date, number_traps, hrs_fished, flow_cfs, turbidity,
# water_t_f, cone_sampling_effort, cone_id, cone_rpm, total_cone_rev

knights_trap_clean_2006 <- knights_effort %>%
  select(-c(debrisVolume, debrisVolumeUnits)) %>%
  group_by(siteName, subSiteName) %>% 
  arrange(visitTime) %>% 
  mutate(stream = "sacramento river",
         site = "knights landing",
         subsite = tolower(subSiteName),
         trap_visit_date = as.Date(visitTime),
         trap_visit_time = as_hms(visitTime),
         trap_stop_date = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as.Date(visitTime),
                                      T ~ as.Date(NA)),
         trap_stop_time = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as_hms(visitTime),
                                      T ~ as_hms(NA)),
         trap_start_date = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") | (fishProcessed == "Processed fish" & visitType != "Start trap & begin trapping") ~ as.Date(lag(visitTime)),
                                     T ~ as.Date(NA)),
         trap_start_time = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") | (fishProcessed == "Processed fish" & visitType != "Start trap & begin trapping") ~ as_hms(lag(visitTime)),
                                     T ~ as_hms(NA)),
         diff = as.numeric(trap_stop_date - trap_start_date),
         trap_start_date = case_when(diff > 7 | diff < -7 ~ as_date(trap_stop_date - 1),
                                     T ~ trap_start_date)) %>%
  rename(trap_visit_id = trapVisitID,
         rpms_start = rpmRevolutionsAtStart,
         rpms_seconds_start = rpmSecondsAtStart,
         rpms_end = rpmRevolutionsAtEnd,
         rpms_seconds_end = rpmSecondsAtEnd,
         counter_start = counterAtStart,
         counter_end = counterAtEnd,
         trap_status = visitType,
         fish_processed = fishProcessed,
         gear_condition_code = trapFunctioning,
         is_half_cone_configuration = halfCone,
         in_thalweg = inThalweg,
         include = includeCatch,
         debris_level = debrisVolumeCat) %>%
  ungroup() %>% 
  select(-c(subSiteName, siteName, visitTime, visitTime2, diff)) %>% 
  mutate(trap_visit_id = as.character(trap_visit_id),
         in_thalweg = case_when(in_thalweg == "Yes" ~ T, 
                                in_thalweg == "No" ~ F,
                                T ~ as.logical(NA)),
         include = case_when(include == "Yes" ~ T, 
                                include == "No" ~ F,
                                T ~ as.logical(NA)),
         is_half_cone_configuration = case_when(is_half_cone_configuration == "Yes" ~ T, 
                                is_half_cone_configuration == "No" ~ F,
                                T ~ as.logical(NA)),
         debris_level = tolower(debris_level),
         trap_status = tolower(trap_status),
         fish_processed = tolower(fish_processed),
         gear_condition_code = tolower(gear_condition_code)) %>% 
  distinct() %>% glimpse()
# should not be processing fish during "Service/adjust/clean trap"
filter(knights_trap_clean_2006, fish_processed == "processed fish", is.na(trap_start_date))

knights_trap_clean_pre2006 <- knights_effort_pre2006 %>% 
  select(-c(location, gear, sampling_period_hrs, cone_sampling_effort,
            flow_cfs, secchi_ft, water_t_f, turbidity, turbidity_units,
            hrs_fished)) %>%
  # convert temp from F to C
  mutate(stream = "sacramento river",
         site = "knights landing",
         subsite = as.character(cone_id),
         # decided to convert to partial sample to fit with other data, this variable isn't very useful regardless
         partial_sample = ifelse(number_traps == 1, T, F)) %>%
  select(-cone_id, - number_traps) %>%
  rename(trap_stop_date = stop_date,
         trap_stop_time = stop_time,
         trap_start_date = start_date,
         trap_start_time = start_time,
         sample_period_revolutions = total_cone_rev,
         rpms_start = cone_rpm) %>%
  mutate(trap_start_date = as_date(trap_start_date),
         trap_stop_date = as_date(trap_stop_date),
         trap_stop_date = case_when(is.na(trap_stop_date) & !is.na(date) ~ date, 
                                    T ~ trap_stop_date),
         diff = as.numeric(trap_stop_date - trap_start_date),
         trap_start_date = case_when(diff > 7 | diff < -7 ~ as_date(trap_stop_date - 1),
                                     T ~ trap_start_date)) %>%
  select(-date, -diff) %>% 
  distinct()

knights_trap_clean_pre2002 <- knight_trap_pre2002 %>% 
  select(date, time, trapid, avg_rpm) %>% 
  mutate(stream = "sacramento river",
         site = "knights landing",
         trapid = ifelse(is.na(trapid), "knights landing", trapid)) %>% 
  rename(subsite = trapid,
         rpms_start = avg_rpm,
         trap_stop_date = date) 
  

knights_trap_clean <- bind_rows(knights_trap_clean_2006, knights_trap_clean_pre2006, knights_trap_clean_pre2002) %>% 
  select(-projectDescriptionID)

# # check to make sure one row per day/time 
# there are multiple rows because time is not captured but trap may be checked multiple times a day
ck <- knights_trap_clean %>%
  group_by(trap_stop_date, subsite, trap_status) %>%
  tally()
filter(knights_trap_clean, trap_stop_date == "2007-12-07")

ck <- knights_trap_clean_pre2006 %>%
  group_by(trap_stop_date,  subsite) %>%
  tally()
knights_trap_clean %>% glimpse
# no issues with trap start and stop date
ck <- knights_trap_clean |> 
  mutate(diff = as.numeric(trap_stop_date - trap_start_date)) |> 
  filter(diff > 6 | diff < -6)

```

### Variables removed

- date: use start_date and end_date
- location: all are KL for Knights Landing
- gear: all are two 8in cones
- sampling_period_hrs: unclear how this variable is different than hrs_fished
- turbidity_units: all are NTU except in 2014 when they are FTU
- cone_sampling_effort: Variable is unclear and is redundant of number of traps and hrs fished
- flow_cfs, secchi_ft, water_t_f, turbidity, turbidity_units included in environmental table
- hrs_fished is a derived field and can be calculated

cone_id is used as a subsite (two traps or cones at Knights Landing)

## Lower Sacramento - Tisdale & Lower Feather River

```{r, tisdale_clean}
# trap_visit_id, trap_start_date, trap_start_time, trap_stop_date, trap_stop_time, sample_period_revolutions, is_half_cone_configuration, river_left_depth, river_center_depth, river_right_depth, in_thalweg, depth_adjust, avg_time_per_rev, fish_properly, comments, gear_condition, stream, site, subsite
filter(tisdale_trap_camp, !is.na(counterAtStart))
# only a few cases where visitTime != visitTime2
filter(tisdale_trap_camp, visitTime != visitTime2)

tisdale_trap_clean <- tisdale_trap_camp %>%
  select(-c(debrisVolume, debrisVolumeUnits)) %>%
  group_by(siteName, subSiteName) %>% 
  arrange(visitTime) %>% 
  mutate(subsite = tolower(subSiteName),
         trap_visit_date = as.Date(visitTime),
         trap_visit_time = as_hms(visitTime),
         trap_stop_date = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as.Date(visitTime),
                                      T ~ as.Date(NA)),
         trap_stop_time = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") ~ as_hms(visitTime),
                                      T ~ as_hms(NA)),
         trap_start_date = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") | (fishProcessed == "Processed fish" & visitType != "Start trap & begin trapping") ~ as.Date(lag(visitTime)),
                                     T ~ as.Date(NA)),
         trap_start_time = case_when(visitType %in% c("Continue trapping", "Unplanned restart", "End trapping") | (fishProcessed == "Processed fish" & visitType != "Start trap & begin trapping") ~ as_hms(lag(visitTime)),
                                     T ~ as_hms(NA)),
         diff = as.numeric(trap_stop_date - trap_start_date),
         trap_start_date = case_when(diff > 7 | diff < -7 ~ as_date(trap_stop_date - 1),
                                     T ~ trap_start_date)) %>%
  rename(trap_visit_id = trapVisitID,
         rpms_start = rpmRevolutionsAtStart,
         rpms_seconds_start = rpmSecondsAtStart,
         rpms_end = rpmRevolutionsAtEnd,
         rpms_seconds_end = rpmSecondsAtEnd,
         counter_start = counterAtStart,
         counter_end = counterAtEnd,
         trap_status = visitType,
         fish_processed = fishProcessed,
         gear_condition_code = trapFunctioning,
         is_half_cone_configuration = halfCone,
         in_thalweg = inThalweg,
         include = includeCatch,
         debris_level = debrisVolumeCat) %>%
  ungroup() %>% 
  select(-c(subSiteName, siteName, visitTime, visitTime2, projectDescriptionID, diff)) %>% 
  mutate(trap_visit_id = as.character(trap_visit_id),
         in_thalweg = case_when(in_thalweg == "Yes" ~ T, 
                                in_thalweg == "No" ~ F,
                                T ~ as.logical(NA)),
         include = case_when(include == "Yes" ~ T, 
                                include == "No" ~ F,
                                T ~ as.logical(NA)),
         is_half_cone_configuration = case_when(is_half_cone_configuration == "Yes" ~ T, 
                                is_half_cone_configuration == "No" ~ F,
                                T ~ as.logical(NA)),
         debris_level = tolower(debris_level),
         trap_status = tolower(trap_status),
         fish_processed = tolower(fish_processed),
         gear_condition_code = tolower(gear_condition_code),
         # fix typos
         trap_stop_date = case_when(trap_start_date == "2019-07-24" ~ as.Date("2019-07-25"),
                                    trap_start_date == "2019-07-26" ~ as.Date("2019-07-27"),
                                    T ~ trap_stop_date),
         trap_stop_time = case_when(trap_start_date %in% c("2019-07-24","2019-07-26") ~ trap_start_time,
                                    T ~ trap_stop_time)) %>%  
  distinct() %>% glimpse()

# # check to make sure one row per day/time 
# there are multiple rows because time is not captured but trap may be checked multiple times a day
ck <- tisdale_trap_clean %>%
  group_by(trap_stop_date, subsite, trap_status) %>%
  tally()
filter(ck, n > 1)
filter(tisdale_trap_clean, trap_stop_date == "2011-03-25")
filter(tisdale_trap_clean, trap_stop_date == "2011-03-26")
filter(tisdale_trap_clean, trap_stop_date == "2011-03-27")

# no issues with trap start and stop date
ck <- tisdale_trap_clean |> 
  mutate(diff = as.numeric(trap_stop_date - trap_start_date)) |> 
  filter(diff > 6 | diff < -6)


```

# Standard format {.tabset}

```{r, combined}
combined_trap_raw <- bind_rows(battle_clear_trap_clean,
                          butte_trap_clean,
                          deer_trap_clean_combined,
                          feather_trap_clean,
                          mill_trap_clean_combined,
                          yuba_trap_clean,
                          knights_trap_clean,
                          tisdale_trap_clean)
colnames(combined_trap_raw)

combined_trap <- combined_trap_raw %>%
  rename(trap_functioning = gear_condition_code,
         visit_type = trap_status) %>%
  mutate(
         trap_functioning = case_when(trap_functioning %in% c("trap not in service") ~ 
                                        "trap not in service",
                                         trap_functioning %in% c("total block", "total blockage",
                                                                 "not rotating", "cone stopped", 
                                                                 "trap stopped functioning") ~ "trap stopped functioning",
                                           trap_functioning %in% c("partial block", "partial blockage", 
                                                                   "trap functioning, but not normally") ~ "trap functioning but not normally",
                                           trap_functioning %in% c("normal", "trap functioning normally") ~ "trap functioning normally",
                                    T ~ "not recorded"),
         debris_level = case_when(debris_level == "veryheavy" ~ "very heavy", 
                                  is.na(debris_level) & trap_functioning %in% c("trap not in service", "trap stopped functioning") ~ as.character(NA),
                                  is.na(debris_level) ~ "not recorded",
                                  T ~ debris_level),
         visit_type = case_when(visit_type %in% c("pull", "end trapping") ~ "end trapping",
                                   visit_type %in% c("set", "start trap & begin trapping") ~ "start trapping",
                                   visit_type %in% c("drive-by only") ~ "drive by",
                                   visit_type %in% c("continue trapping",  "check") ~ "continue trapping",
                                   visit_type %in% c("unplanned restart", "breached", "set/pull") ~ "unplanned restart",
                                   visit_type %in% c("service/adjust/clean trap") ~ "service trap",
                                 T ~ "not recorded"),
         fish_processed = case_when(fish_processed == "processed fish" ~ "processed fish",
                                      fish_processed == "no fish were caught" ~ "no fish caught",
                                      fish_processed == "no catch data; fish released" ~ "no catch data, fish released",
                                      fish_processed == "no catch data; fish left in live box" ~ "no catch data, fish left in live box",
                                    T ~ "not recorded"),
         trap_start_date = case_when(is.na(trap_start_date) ~ as.Date(trap_visit_date), 
                                     T ~ as.Date(trap_start_date)),
         trap_start_time = case_when(is.na(trap_start_time) ~ as_hms(trap_visit_time),
                                     T ~ as_hms(trap_start_time)),
         gear_type = ifelse(is.na(gear_type), "rotary screw trap", gear_type),
         # convert ft to m and inches to cm
         depth_adjust = depth_adjust*2.54,
         rpms_start = case_when(!is.na(rpms_seconds_start) & rpms_seconds_start != 60 ~ rpms_start*60/rpms_seconds_start,
                                is.infinite(rpms_start) ~ 0,
                                T ~ rpms_start),
         rpms_end = case_when(!is.na(rpms_seconds_end) & rpms_seconds_end != 60 ~ rpms_end*60/rpms_seconds_end,
                                T ~ rpms_end),
         in_thalweg = ifelse(is.na(in_thalweg), T, in_thalweg),
         partial_sample = ifelse(is.na(partial_sample), F, partial_sample),
         is_half_cone_configuration = ifelse(is.na(is_half_cone_configuration), F, is_half_cone_configuration),
         include = ifelse(is.na(include), T, include)) %>% 
  select(-rpms_seconds_end, -rpms_seconds_start) |> 
  bind_rows(rbdd_trap)
         


unique(combined_trap_raw$is_half_cone_configuration)
unique(combined_trap$fish_processed)
unique(combined_trap$visit_type)
unique(combined_trap$trap_functioning)
unique(combined_trap$debris_level)

combined_trap %>% glimpse()

combined_trap_final <- combined_trap %>% 
  relocate(c(trap_visit_date, trap_visit_time), .before = trap_start_date) %>% 
  relocate(c(stream, site, subsite), .after = trap_visit_id) %>% 
  relocate(c(visit_type, trap_functioning, fish_processed, gear_type, in_thalweg, partial_sample, is_half_cone_configuration), .after = trap_stop_time) %>% 
  relocate(c(sample_period_revolutions,include,comments), .after = last_col()) %>% 
  relocate(debris_level, .after = debris_volume)

ck <- combined_trap_final |> 
  mutate(diff = as.numeric(trap_stop_date - trap_start_date)) |> 
  filter(diff > 7 | diff < -7)
```

## Exploratory plots

# QA/QC {.tabset}

## trap_start_date, trap_sample_date

```{r}
combined_trap %>% 
  ggplot(aes(x = trap_stop_date, y = site, color = site)) +
  geom_point()

combined_trap %>% 
  ggplot(aes(x = trap_start_date, y = site, color = site)) +
  geom_point()
```

## trap_start_time, trap_sample_time

Does not appear that traps are checked at a specific time

```{r}
combined_trap %>% 
  ggplot(aes(x = trap_stop_time, y = site, color = site)) +
  geom_point()

combined_trap %>% 
  ggplot(aes(x = trap_start_time, y = site, color = site)) +
  geom_point()
```

## sample_period_revolutions

```{r}
combined_trap %>%
  ggplot(aes(x = trap_stop_date, y = sample_period_revolutions, color = stream)) +
  geom_point()

# There are a few Yuba River obs that seem unlikely
# Leaving as is for now
filter(combined_trap, sample_period_revolutions > 250000)
```

## is_half_cone_configuration

Battle and Clear collect data on cone setting. Battle is almost always at full cone
and Clear is at half cone more frequently.

```{r}
combined_trap %>%
  filter(!is.na(is_half_cone_configuration)) %>%
  group_by(stream, is_half_cone_configuration) %>%
  tally() %>%
  kable()
```


## thalweg

Battle and Clear collect information of trap in thalweg and it is almost always TRUE.

```{r}
combined_trap %>%
  filter(!is.na(in_thalweg)) %>%
  group_by(stream, in_thalweg) %>%
  tally() %>%
  kable()
```


## comments

There is some important information about data accuracy in comments. It would
take a lot of effort to encode these comments.

```{r}
select(combined_trap, comments) %>% filter(!is.na(comments)) %>% glimpse
```

## trap_functioning


```{r}
total <-
  combined_trap %>%
  group_by(year(trap_stop_date), stream) %>%
  tally() %>%
  rename(total = n)
combined_trap %>%
  group_by(year(trap_stop_date), stream, trap_functioning) %>%
  tally() %>%
  left_join(total) %>%
  mutate(percent = n/total) %>%
  ggplot(aes(x = `year(trap_stop_date)`, y = percent, fill = trap_functioning)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~stream)
```

## partial_sample

Battle and Clear collect this data. Based on this decided to remove. Mostly all TRUE and this information can come from calculating hours (start_date compared to sample_date)

```{r}
combined_trap %>%
  filter(!is.na(partial_sample)) %>%
  group_by(stream, partial_sample) %>%
  tally() %>%
  kable()
```

## location, site, subsite

```{r}
combined_trap %>%
  group_by(stream, site, subsite) %>%
  tally()
```

## debris_volume

```{r}
combined_trap %>%
  ggplot(aes(x = trap_stop_date, y = debris_volume, color = stream)) +
  geom_point()

combined_trap %>%
  ggplot(aes(x = stream, y = debris_volume)) +
  geom_boxplot()
```

## visit_type

This data is really only used by Feather. Majority of Butte and Yuba were encoded as "check" which was mapped to "continue trapping"

```{r}
combined_trap %>%
  group_by(year(trap_stop_date), stream, visit_type) %>%
  tally() %>%
  left_join(total) %>%
  mutate(percent = n/total) %>%
  ggplot(aes(x = `year(trap_stop_date)`, y = percent, fill = visit_type)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~stream)

```

## rpms_start, rpms_end

```{r}
combined_trap %>%
  ggplot(aes(x = trap_stop_date, y = rpms_start, color = stream)) +
  geom_point()

filter(combined_trap, rpms_start < 100) %>%
  ggplot(aes(x = trap_stop_date, y = rpms_start, color = stream)) +
  geom_point()
combined_trap %>%
  ggplot(aes(x = trap_stop_date, y = rpms_end, color = stream)) +
  geom_point()

combined_trap %>%
  ggplot(aes(x = stream, y = rpms_start)) +
  geom_boxplot()
combined_trap %>%
  ggplot(aes(x = stream, y = rpms_end)) +
  geom_boxplot()
```

## fish processed

```{r}
combined_trap %>%
  group_by(year(trap_stop_date), stream, fish_processed) %>%
  tally() %>%
  left_join(total) %>%
  mutate(percent = n/total) %>%
  ggplot(aes(x = `year(trap_stop_date)`, y = percent, fill = fish_processed)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~stream)

```

## gear_type

```{r}
combined_trap %>%
  group_by(year(trap_stop_date), stream, gear_type) %>%
  tally() %>%
  left_join(total) %>%
  mutate(percent = n/total) %>%
  ggplot(aes(x = `year(trap_stop_date)`, y = percent, fill = gear_type)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~stream)
```

## debris_level

```{r}
combined_trap %>%
  group_by(year(trap_stop_date), stream, debris_level) %>%
  tally() %>%
  left_join(total) %>%
  mutate(percent = n/total) %>%
  ggplot(aes(x = `year(trap_stop_date)`, y = percent, fill = debris_level)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~stream)
```
```{r, include = F}
check_dates <- function(dat) {
  dat |> 
    group_by(stream, site, subsite) |> 
    summarize(min_date = min(trap_stop_date),
              max_date = max(trap_stop_date))
}

combined_trap |> 
  check_dates() |> 
  view()

```

# Save data

```{r}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(combined_trap_final,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_rst_trap.csv",
           predefinedAcl = "bucketLevel")
```

