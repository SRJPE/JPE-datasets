---
title: "Create standard format for RST catch data"
output: html_document
---

```{r, include = F}
library(dtplyr)
library(data.table)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(knitr)
library(hms)
library(EDIutils)

root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
knitr::opts_chunk$set(echo = TRUE)
```

Data were checked and cleaned in scripts available [here](https://github.com/FlowWest/JPE-datasets/tree/main/scripts/rst)

```{r, data_pull, include = F, echo = F, eval = F}
# # Data pull ---------------------------------------------------------------
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# daily yearling ruleset
gcs_get_object(object_name = "standard-format-data/daily_yearling_ruleset.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data", "daily_yearling_ruleset.csv"),
               overwrite = TRUE)

# define files to pull in (in some cases there is just one catch file while others
# have sample and environmental data)
# files_battle <- tibble(path = rep("rst/battle-creek/data/battle_",4),
#                        name = c("rst_catch","rst_environmental","rst_passage_estimates", "mark_reacpture"),
#                        save = rep(here::here("data","rst", "battle_rst_"), 4))

files_battle_clear <- tibble(path = "rst/battle_clear_",
                             name = c("catch_edi", "environmental_edi", "recapture_edi","release_edi","trap_edi"),
                             save = rep(here::here("data","rst","battle_clear_"),5))
files_butte <- tibble(path = "rst/butte-creek/data/butte_rst_05152025",
                      name = c(""),
                      save = here::here("data","rst", "butte_rst_05152025"))
files_butte_camp <- tibble(path = rep("rst/butte-creek/data-raw/butte_",3),
                        name = c("catch_camp","trap_camp", "environmental_camp"),
                        save = rep(here::here("data","rst", "butte_"), 3))
# files_clear <- tibble(path = rep("rst/clear-creek/data/clear_",4),
#                       name = c("rst_catch","rst_environmental","rst_passage_estimates", "mark_reacpture"),
#                       save = rep(here::here("data", "rst", "clear_rst_"), 4))
files_deer <- tibble(path = "rst/deer-creek/data/deer_rst",
                     name = c(""),
                     save = here::here("data","rst", "deer_rst"))
files_feather <- tibble(path = rep("rst/feather-river/data/feather_rst",2),
                        name = c("","_effort"),
                        save = rep(here::here("data","rst", "feather_rst"), 2))
files_feather_camp <- tibble(path = rep("rst/feather-river/data-raw/feather_",3),
                        name = c("catch_camp","trap_camp", "environmental_camp"),
                        save = rep(here::here("data","rst", "feather_"), 3))
files_knights <- tibble(path = rep("rst/lower-sac-river/data-raw/knights-landing/knights_",2),
                        name = c("catch_camp", "trap_camp"),
                        save = rep(here::here("data","rst", "knights_"), 2))
files_knights_pre2006 <- tibble(path = rep("rst/lower-sac-river/data/knights-landing/knl_",2),
                        name = c("combine_rst_clean", "combine_sampling_effort_clean"),
                        save = rep(here::here("data","rst", "knights_"), 2))
files_knights_pre2002 <- tibble(path = rep("rst/lower-sac-river/data/knights-landing/pre-2002-",5),
                        name = c("efficiency", "mark", "recap","trap","rst"),
                        save = rep(here::here("data","rst", "knights_2002_"), 5))
files_tisdale <- tibble(path = "rst/lower-sac-river/data/tisdale/rst_clean",
                        name = c(""),
                        save = here::here("data","rst", "tisdale_rst"))
files_tisdale_camp <- tibble(path = "rst/lower-sac-river/data-raw/tisdale/tisdale_",
                        name = c("catch_camp", "trap_camp"),
                        save = here::here("data","rst", "tisdale_rst_"))
files_mill <- tibble(path = "rst/mill-creek/data/mill_rst",
                     name = c(""),
                     save = here::here("data","rst", "mill_rst"))
files_yuba <- tibble(path = "rst/yuba-river/data/yuba_rst",
                     name = c(""),
                     save = here::here("data","rst", "yuba_rst"))
# function to save file to disk
get_data <- function(path, name, save) {
  gcs_get_object(object_name = paste0(path, name, ".csv"),
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = paste0(save, name, ".csv"),
                 overwrite = TRUE)
}
# apply function to each set of files
pmap(files_battle_clear, get_data)
pmap(files_butte, get_data)
pmap(files_butte_camp, get_data)
pmap(files_deer, get_data)
pmap(files_feather, get_data)
pmap(files_feather_camp, get_data)
pmap(files_knights, get_data)
pmap(files_knights_pre2006, get_data)
pmap(files_knights_pre2002, get_data)
pmap(files_tisdale, get_data)
pmap(files_tisdale_camp, get_data)
pmap(files_mill, get_data)
pmap(files_yuba, get_data)

gcs_get_object(object_name = "rst/rbdd/data/catch.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/rst/rbdd_rst.csv",
               overwrite = TRUE)
```

```{r, read_csv}
# load in data
daily_yearling_ruleset <- read_csv(here::here("data", "daily_yearling_ruleset.csv"))
# catch data
battle_clear_rst <- read_csv(here::here("data", "rst", "battle_clear_catch_edi.csv"), lazy = FALSE )
butte_rst <- read_csv(here::here("data", "rst", "butte_rst_05152025.csv"), lazy = FALSE ) # contains trap data too
butte_rst_camp <- read_csv(here::here("data", "rst", "butte_catch_camp.csv"), lazy = FALSE )
deer_rst <- read_csv(here::here("data", "rst", "deer_rst.csv"), lazy = FALSE ) # contains trap data too
feather_rst <- read_csv(here::here("data", "rst", "feather_rst.csv"), lazy = FALSE )
feather_rst_camp <- read_csv(here::here("data", "rst", "feather_catch_camp.csv"), lazy = FALSE )
knights_landing_rst <- read_csv(here::here("data", "rst", "knights_catch_camp.csv"), lazy = FALSE )
knights_landing_pre2006 <- read_csv(here::here("data", "rst", "knights_combine_rst_clean.csv"), lazy = FALSE )
knights_landing_pre2002 <- read_csv(here::here("data", "rst", "knights_2002_rst.csv"), lazy = FALSE )
tisdale_rst <- read_csv(here::here("data", "rst", "tisdale_rst.csv"), lazy = FALSE )
tisdale_rst_camp <- read_csv(here::here("data", "rst", "tisdale_rst_catch_camp.csv"), lazy = FALSE )
mill_rst <- read_csv(here::here("data", "rst", "mill_rst.csv"), lazy = FALSE ) # contains trap data too
yuba_rst <- read_csv(here::here("data", "rst", "yuba_rst.csv"), lazy = FALSE )
rbdd_rst <- read_csv(here::here("data", "rst", "rbdd_rst.csv"), lazy = FALSE)

# sampling effort and environmental
battle_clear_environmental <- read_csv(here::here("data","rst", "battle_clear_environmental_edi.csv"), lazy = FALSE )
battle_clear_recapture <- read_csv(here::here("data","rst", "battle_clear_recapture_edi.csv"), lazy = FALSE )
battle_clear_release <- read_csv(here::here("data","rst", "battle_clear_release_edi.csv"), lazy = FALSE )
butte_trap_camp <- read_csv(here::here("data", "rst", "butte_trap_camp.csv"), lazy = FALSE )
feather_effort <- read_csv(here::here("data", "rst", "feather_rst_effort.csv"), lazy = FALSE )
feather_trap_camp <- read_csv(here::here("data", "rst", "feather_trap_camp.csv"), lazy = FALSE )
knights_effort <- read_csv(here::here("data", "rst", "knights_trap_camp.csv"), lazy = FALSE )
knights_effort_pre2006 <- read_csv(here::here("data", "rst", "knights_combine_sampling_effort_clean.csv"), lazy = FALSE )
knight_effort_pre2002 <-  read_csv(here::here("data", "rst", "knights_2002_trap.csv"), lazy = FALSE )
tisdale_trap_camp <- read_csv(here::here("data", "rst", "tisdale_rst_trap_camp.csv"), lazy = FALSE )
```


```{r, include = F}
gcs_get_object(object_name = "rst/RiverLAD.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data", "river_lad.csv"),
               overwrite = TRUE)
lad <- read_csv(here::here("data", "river_lad.csv"))
```

# Data formatting {.tabset}

We format, check, and clean catch data for each stream individually because their
raw format varies. After formatting all streams we combine and apply additional
cleaning and formatting.

Battle, Clear, Feather, and Knights Landing provided trap operations/environmental
data separate from catch. In some cases, there may be trap operations/environmental
data but no catch observations for that day. In those cases, we assume that catch was 
zero and was not recorded. To capture all data (including zero catch) we combine
dates with trap operations/environmental with catch data and assume zero catch
if that date did not exist in the catch data.

```{r, helpers}
# standard encoding fixes for run
# These functions use data.table because it performs faster
run_encoding_dt <- function(dat) {
  dat[, run := fcase(
    count == 0, NA_character_,
    (count > 0 & is.na(run)) | run == "not recorded" |  run == "not applicable (n/a)" | run == "unknown", "not recorded",
    run == "outlier salmon", "unknown",
    run == "fall", "fall",
    run == "winter", "winter",
    run == "spring", "spring",
    run == "late fall", "late fall")
    ]
}

run_method_encoding_dt <- function(dat) {
  dat[, run_method := fcase(
    count == 0, NA_character_,
    (count > 0 & is.na(run_method)) | run_method == "not recorded", "not recorded",
    run_method == "length-at-date criteria", "length-at-date criteria",
    run_method == "hatchery attribute", "hatchery attribute",
    run_method == "appearance", "appearance")
    ]
}

# note that there is only one "yoy (young of the year)"
# Older juveniles only existed in the excel spreadsheets provided by Knights Landing
# We only use the spreadsheets for sampling before 2006 because the rest is in CAMP
# There are no older juveniles before 2006

lifestage_encoding_dt <- function(dat) {
  dat[, lifestage := fcase(
  count == 0, NA_character_,
  lifestage %in% c("not recorded", "not provided") | (count != 0 & is.na(lifestage)), "not recorded",
  lifestage %in% c("yolk-sac fry", "yolk sac fry (alevin)", "yolk sac fry"), "yolk sac fry",
  lifestage %in% c("silvery parr", "fingerling", "pre-smolt"), "silvery parr",
  lifestage %in% c("unknown", "yoy (young of the year)", "juvenile"), "unknown",
  
  lifestage == "parr", "parr",
  lifestage %in% c("fry", "button-up fry", "fry (button-up)"), "fry",
  lifestage == "smolt", "smolt",
  lifestage == "adult", "adult",
  lifestage %in% c("yearling", "older juvenile"), "yearling"
 )]
}
```

## Battle & Clear Creek

```{r, battle_clean}
### Catch #####
battle_clear_rst %>% glimpse()
unique(battle_clear_rst$run)
unique(battle_clear_rst$lifestage)
filter(battle_clear_rst, is.na(fork_length), count > 0) %>% glimpse
filter(battle_clear_rst, is.na(run)) %>% glimpse

# Note that there are many repeat entries where all values are the same except count
# ck <- battle_clear_rst %>% 
#   group_by(date, site, run, fork_length, weight, lifestage, interpolated, species, subsite) %>% 
#   count() %>% 
#   filter(n > 1)
# # There are also repeat entries where all are the same. Need to double check that these are not duplicates. Checked the data pulled from EDI and there are the same number of records so assume there are no duplicates.
# ck <- battle_clear_rst %>% 
#   group_by(date, site, run, fork_length, weight, lifestage, interpolated, species, subsite, count) %>% 
#   count() %>% 
#   filter(n > 1)

# notes to include
# some data may be interpolated (~1% may be interpolated)
# run is not filtered
# TODO compare mean observed v interpolated to decide if we should use
# Origin - Natural because trap is above that hatchery
# run method: fWS_race (Sheila Greene LAD with adjustments, all fall run are spring run)

battle_clear_rst_clean <- battle_clear_rst %>%
  group_by(stream, site, subsite, date, run, fork_length, lifestage, interpolated) %>%
  summarize(count = sum(count, na.rm = T))

battle_clear_rst_min <- battle_clear_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy, stream, site, subsite) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

battle_clear_trap_clean <- battle_clear_environmental %>%
  # use sample date because this is the date the trap would have been checked
  select(date, stream, site, subsite) %>% 
  distinct()

battle_clear_trap_min <- battle_clear_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy, stream, site, subsite) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
battle_clear_min_date_compare <- full_join(battle_clear_rst_min, battle_clear_trap_min)

# The biggest difference is 19 days
ck <- battle_clear_min_date_compare |> 
  filter(min != trap_min) |> 
  mutate(off = trap_min - min)

# select recaptured fish to add to full catch table
battle_clear_recapture_format <- battle_clear_recapture |> 
  rename(date = date_recaptured,
         count = number_recaptured) |> 
  mutate(species = "chinook salmon") |> 
  select(-median_fork_length_recaptured)
  
# This contains ALL data
battle_clear_rst_clean_final <- battle_clear_rst |> 
  mutate(count = ifelse(is.na(count), 0, count),
         adipose_clipped = F,
         run_method = "adjusted length-at-date",
         release_id = NA) %>% 
  bind_rows(battle_clear_recapture_format)

# convert to data table for faster mutation
setDT(battle_clear_rst_clean_final)
# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
battle_clear_rst_clean_final %>% 
  run_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- sample_id: unable to connect this to any additional data so it is not relevant
to include


## Butte Creek

All data pre 2015 was shared with us in excel spreadsheets. Post 2015 data is stored and shared using the CAMP platform. 

```{r, butte_data_dictionary}
butte_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                             "data-dictionaries", "butte_rst_data_dictionary.rds"))
kable(butte_data_dictionary)
```

```{r, butte_clean}
# Run was filtered to spring (or only spring is collected) prior to sharing data
# According to methods (https://www.calfish.org/ProgramsData/ConservationandManagement/CentralValleyMonitoring/SacramentoValleyTributaryMonitoring/ButteCreek.aspx)
# the trapping site is downstream of spring run spawning habitat but upstream of fall run spawning habitat
# TODO uncertainty associated with trapping spring - what percentage may be fall?
butte_rst %>% glimpse
unique(butte_rst$station)
unique(butte_rst$mark_code)
unique(butte_rst$gear_id)
unique(butte_rst$lifestage)
ck <- filter(butte_rst, gear_id == "diversion fyke trap 1")
filter(butte_rst, is.na(fork_length), count > 0) %>% glimpse
filter(butte_rst, is.na(mark_code)) %>% tally()

butte_rst_clean_pre_2015 <- butte_rst %>%
  select(date, station, dead, count, fork_length, weight, mark_code, lifestage, gear_id) %>%
  rename(adipose_clipped = mark_code, 
         subsite = station) %>%
  mutate(stream = "butte creek",
         site = case_when(grepl("Okie Dam", subsite) ~ "okie dam",
                          T ~ tolower(subsite)),
         subsite = ifelse(gear_id == "diversion fyke trap 1", "okie dam fyke trap", tolower(subsite)),
         run = "spring",
         adipose_clipped = case_when(adipose_clipped == "none" ~ F,
                            adipose_clipped == "adclipped" ~ T),
         run_method = "not recorded",
         species = "chinook salmon") %>%
  group_by(date, site, subsite, dead, fork_length, weight, adipose_clipped, lifestage, stream, run, run_method, species) %>%
  summarize(count = sum(count, na.rm = T)) 

ck <- butte_rst_clean_pre_2015 |> 
  mutate(monitoring_year = ifelse(month(date) %in% 9:12, year(date) + 1, year(date))) |> 
  group_by(monitoring_year) |> 
  summarize(total_count = sum(count, na.rm=T))

```

Prep data from CAMP to combine with RST clean
```{r, butte_camp_clean}
butte_rst_clean_camp <- butte_rst_camp %>%
  # seems like there are catch entries when it wasn't a sampling visit, remove these
  filter(fishProcessed != "N/A; not a sampling visit") %>% 
  # removing existing mark for now. will add all those in later
  select(-c(catchRawID, trapVisitID, visitTime2, markType_1, markColor_1, markPosition_1, markCode_1, fishProcessed)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         lifestage = lifeStage,
         date = visitTime,
         run_method = runMethod,
         site = siteName,
         subsite = subSiteName,
         release_id = releaseID,
         dead = mort) %>% 
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped, run_method, site, subsite, release_id) %>%
  summarize(count = sum(n, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(stream = "butte creek",
         site = "okie dam", # only fish okie dam site past 2015 
         subsite = ifelse(subsite == "PP RST", "okie dam 1", "okie dam fyke trap"),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) %>% glimpse()

```

Combine butte pre 2015 (excel) and post 2015 (CAMP). No temporal overlap in datasets so we can just bind rows
```{r, combine_butte}
# bind rows
butte_rst_clean <- bind_rows(butte_rst_clean_pre_2015, butte_rst_clean_camp) %>% glimpse()
ck <- butte_rst_clean |> 
  mutate(monitoring_year = ifelse(month(date) %in% 9:12, year(date) + 1, year(date))) |> 
  group_by(monitoring_year) |> 
  summarize(total_count = sum(count, na.rm=T))
```

Check that all days trap running have catch rows
```{r}
butte_rst_min <- butte_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# pre 2015 all catch and trap stored in one spot
butte_trap_pre_2015 <- butte_rst %>% 
  select(date) %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

butte_trap_camp_dates <-  butte_trap_camp %>%
  # no fish are processed on these days so don't want to include catch data
  filter(fishProcessed != "N/A; not a sampling visit") %>% 
  mutate(wy = ifelse(month(visitTime) %in% 10:12, year(visitTime) + 1, year(visitTime))) %>% 
  group_by(wy) %>% 
  summarize(min = min(visitTime))

butte_trap_combined <- bind_rows(butte_trap_pre_2015, butte_trap_camp_dates) %>%  rename(trap_min = min)

# min date in catch and trap aligns 
butte_min_date_compare <- full_join(butte_rst_min, butte_trap_combined)
```


```{r, final_butte_edits}
# find all dates that a trap that is not okie dam fyke trap is running
unique(butte_rst_clean$subsite)
keep_dates <- butte_rst_clean %>% 
  filter(subsite != "okie dam fyke trap") %>% 
  pull(date)

butte_rst_clean <- butte_rst_clean %>%
  filter(date %in% keep_dates) # keep only dates with RST sampling - not fyke only 
ck <- butte_rst_clean |> 
  mutate(monitoring_year = ifelse(month(date) %in% 9:12, year(date) + 1, year(date))) |> 
  group_by(monitoring_year) |> 
  summarize(total_count = sum(count, na.rm=T))
setDT(butte_rst_clean)
# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
butte_rst_clean %>% 
  # run mutate not applied because all spring
  lifestage_encoding_dt() 
```




### Variables removed

- trap_status, gear_id, north_brush, south_brush, debris, comments, trap_revolutions, rpms_start, rpms_end: included in operations table
- weather, temperature, turbidity, secchi, velocity: included in environmental table
- time is removed because this is captured in trap operations table

## Deer Creek

```{r, deer_data_dictionary}
deer_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                            "data-dictionaries", "deer_rst_data_dictionary.rds"))
kable(deer_data_dictionary)
```

```{r, deer_clean}
deer_rst %>% glimpse
unique(deer_rst$location)
filter(deer_rst, is.na(fork_length), count > 0) %>% glimpse

deer_rst_clean <- deer_rst %>%
  select(date, location, count, fork_length, weight) %>%
  group_by(date, fork_length, weight) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "deer creek",
         site = stream,
         subsite = site,
         run = "not recorded",
         run_method = "not recorded",
         adipose_clipped = F,
         lifestage = "not recorded",
         species = "chinook salmon")
```

We will be handling data updates for Deer and Mill through DataTackle but 2021-2023 need to be added to historical data because they are not handled by DataTackle. The 2023-2024 season and forward will be handled by DataTackle.

```{r}
res <- read_data_entity_names(packageId = "edi.1504.3")
raw <- read_data_entity(packageId = "edi.1504.3", entityId = res$entityId[1])
deer_mill_catch_raw <- read_csv(file = raw)

new_deer_catch <- deer_mill_catch_raw |> 
  filter(stream == "deer creek", date > max(deer_rst_clean$date)) |> 
  mutate(site = stream,
         subsite = site,
         run = "not recorded",
         run_method = "not recorded",
         adipose_clipped = F)

deer_rst_clean_combined <- bind_rows(deer_rst_clean,
                                      new_deer_catch)
```


### Variables removed

- flow, turbidity, weather, water_temperature_celsius: included in environmental table
- tubs_of_debris, trap_condition_code, comments, time_for_10_revolutions: included in operations table

## Feather River

```{r, feather_data_dictionary}
feather_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                               "data-dictionaries", "feather_rst_data_dictionary.rds"))
kable(feather_data_dictionary)
```

There are differences between the original excel spreadsheet provided and the
CAMP database. There are 400+ cases where there are small discrepancies between
count when grouped by date, site and run.

There are many cases where run is "not recorded" in CAMP and few cases in the
original excel files. Decided to use the run recorded in CAMP because no information
how run was being assigned in the excel files. Run can be filled in using the
standard length at date model.

To the best of our knowledge, Feather uses CAMP to store their data so CAMP
should be the most reliable data source.

```{r, compare_feather}
feather_excel_test <- feather_rst %>% 
  group_by(date, site_name, run) %>% 
  summarize(count = sum(count, na.rm = T)) %>% 
  rename(site = site_name,
         excel = count) 
  

feather_camp_test <- feather_rst_camp %>% 
  select(-c(catchRawID, trapVisitID, releaseID, visitTime2)) %>%
  #combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun) & finalRun != "Not recorded", finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>%
  select(-c(finalRun, finalRunMethod, atCaptureRun, atCaptureRunMethod)) %>%
  filter(commonName == "Chinook salmon") %>% 
  rename(fork_length = forkLength,
         lifestage = lifeStage,
         date = visitTime,
         site = siteName) %>%
  group_by(date, site, run) %>%
  summarize(count = sum(n, na.rm = T)) %>% 
  rename(camp = count) %>% 
  mutate(run = tolower(run))

compare <- full_join(feather_excel_test, feather_camp_test)
filter(compare, excel != camp)
filter(compare, run == "not recorded") %>% group_by(year(date)) %>% tally()
filter(feather_excel_test, is.na(run)) %>% group_by(year(date)) %>% tally()
```

```{r, feather_clean}
feather_rst %>% glimpse
feather_rst_camp %>% glimpse
# same dates for the excel sheets vs CAMP so use CAMP
min(feather_rst$date)
min(feather_rst_camp$visitTime)
ck <- filter(feather_rst_camp, is.na(visitTime))
# many obs where run is NA
unique(feather_rst_camp$run)
#filter(feather_rst_camp, is.na(run), commonName == "Chinook salmon", n >0)
unique(feather_rst_camp$commonName)
unique(feather_rst_camp$fishOrigin)
unique(feather_rst_camp$markType)
filter(feather_rst_camp, visitTime != visitTime2)


# multiple back and forth about how to treat this - decided to add site group variable
# organize feather subsites by high flow channel and low flow channel to make easier to understand
lfc <- c("eye riffle_north", "eye riffle_side channel", "gateway main 400' up river", "gateway_main1", "gateway_rootball", "gateway_rootball_river_left", "#steep riffle_rst", "steep riffle_10' ext", "steep side channel")
hfc <- c("herringer_east", "herringer_upper_west", "herringer_west", "live oak", "shawns_east", "shawns_west", "sunset east bank", "sunset west bank")
feather_rst_clean <- feather_rst_camp %>%
  # removing existing mark for now. will add all those in later
  select(-c(catchRawID, trapVisitID, visitTime2, markType_1, markColor_1, markPosition_1, markCode_1)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         lifestage = lifeStage,
         date = visitTime,
         run_method = runMethod,
         site = siteName,
         subsite = subSiteName,
         release_id = releaseID,
         dead = mort) %>%
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped, run_method, site, subsite, release_id) %>%
  summarize(count = sum(n, na.rm = T)) %>%
  ungroup() %>%
  mutate(stream = "feather river",
         subsite = tolower(subsite),
         site = tolower(site),
         site_group = case_when(subsite %in% lfc ~ "feather river lfc",
                                subsite %in% hfc ~ "feather river hfc",
                                T ~ NA),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) 

feather_rst_min <- feather_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

feather_trap_clean <- feather_trap_camp %>%
  rename(date = visitTime) %>%
  distinct(date, siteName)

feather_trap_min <- feather_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
# no difference for feather
feather_min_date_compare <- full_join(feather_rst_min, feather_trap_min)

setDT(feather_rst_clean)
feather_rst_clean %>% 
  run_encoding_dt() %>% 
  run_method_encoding_dt() %>% 
  lifestage_encoding_dt()

ck2 <- feather_rst_clean |> 
  filter(species == 'chinook salmon') |> 
  mutate(monitoring_year = ifelse(month(date) %in% 9:12, year(date) + 1, year(date))) |>
  group_by(monitoring_year, site) |> 
  summarize(total_count = sum(count, na.rm = T))
```

## Mill Creek

```{r, mill_data_dictionary}
mill_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                            "data-dictionaries", "mill_rst_data_dictionary.rds"))
kable(mill_data_dictionary)
```

```{r, mill_clean}
# No hours fishing data available
# Run is not collected
mill_rst %>% glimpse
unique(mill_rst$location)
filter(mill_rst, is.na(fork_length), count > 0) %>% glimpse
filter(mill_rst, is.na(count))

mill_rst_clean <- mill_rst %>%
  select(date, count, fork_length) %>%
  group_by(date, fork_length) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "mill creek",
         site = stream,
         subsite = site,
         run = "not recorded",
         run_method = "not recorded",
         adipose_clipped = F,
         lifestage = "not recorded",
         species = "chinook salmon")
```

```{r}
new_mill_catch <- deer_mill_catch_raw |> 
  filter(stream == "mill creek", date > max(mill_rst_clean$date)) |> 
  mutate(site = stream,
         subsite = site,
         run = "not recorded",
         run_method = "not recorded",
         adipose_clipped = F)

mill_rst_clean_combined <- bind_rows(mill_rst_clean,
                                      new_mill_catch)
```

### Variables removed

- flow, water_temperature, turbidity, weather: included in environmental table
- tubs_of_debris, trap_condition_code, comments, time_for_10_revolutions: included in operations table

## Yuba River

```{r, yuba_data_dictionary}
yuba_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                            "data-dictionaries", "yuba_rst_data_dictionary.rds"))
kable(yuba_data_dictionary)
```

```{r, yuba_clean}
yuba_rst %>% glimpse
unique(yuba_rst$location)
unique(yuba_rst$run)
ck <- filter(yuba_rst, is.na(run), !is.na(count), count > 0)
# all are CHN
unique(yuba_rst$organism_code)
unique(yuba_rst$lifestage)
# note that run designation is a combination of run and lifestage.
# run not filtered
# sites are names for traps at the same location and should be summed

filter(yuba_rst, is.na(fork_length), count > 0) %>% glimpse
filter(yuba_rst, is.na(run), count > 0) %>% glimpse
filter(yuba_rst, run == "unknown") %>% glimpse

yuba_rst_clean<- yuba_rst %>%
  select(date, fork_length, weight, lifestage, count, run, location) %>%
  mutate(site = "hallwood", # there are some cases where location is "Yuba River" Casey Campos said via email to Ashley Vizek that these should be Hallwood
         date = as_date(date),
         subsite = case_when(location == "Yuba River" ~ "hal", # assume the Yuba River ones are hal. it should not matter too much.
                             location == "5 foot RST at Hallwood" ~ "hal3",
                             location == "RST 1 at Hallwood on Yuba River" ~ "hal",
                             location == "RST 2 at Hallwood" ~ "hal2")) %>%
  group_by(date, fork_length, weight, lifestage, run, site, subsite) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "yuba river",
         adipose_clipped = F,
         run_method = "not recorded",
         species = "chinook salmon") 
# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
setDT(yuba_rst_clean)
yuba_rst_clean %>% 
  run_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- method, trap_status, debris, comments, trap_revolutions, trap_revolutions2, rpms_before, rpms_after: included in operations table
- temperature, turbidity, velocity: included in environmental table
- organism_code removed because all are CHN
- time removed because this is captured in trap operations

## Lower Sacramento - Knights Landing

```{r, knights_clean}
unique(knights_landing_rst$commonName)
unique(knights_landing_rst$fishOrigin)
unique(knights_landing_rst$run)
#filter(knights_landing_rst, run == "Not applicable (n/a)") %>% glimpse
filter(knights_landing_rst, is.na(forkLength), n > 0) %>% glimpse
#unique(knights_landing_rst$runMethod)
unique(knights_landing_rst$lifeStage)
unique(knights_landing_pre2006$lifestage)
filter(knights_landing_pre2006, lifestage == "older juvenile") %>% tally()
# check missing trap days
filter(knights_effort, visitTime == "2014-02-15")

# 1,603 unknown, 2 not recorded
filter(knights_landing_rst, fishOrigin == "Unknown") %>% tally()

knights_rst_clean_camp <- knights_landing_rst %>%
  select(-c(catchRawID, trapVisitID, visitTime2, visitType, markCode_1, markType_1, markColor_1, markPosition_1, markType_2, markColor_2, markPosition_2, markCode_2, markType_3, markColor_3, markPosition_3, markCode_3)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(count = n,
         date = visitTime,
         fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         run_method = runMethod,
         lifestage = lifeStage,
         release_id = releaseID,
         subsite = subSiteName,
         dead = mort) %>%
  group_by(fork_length, weight, species, run, run_method, lifestage, adipose_clipped, date, release_id, subsite, dead) %>%
  summarize(count = sum(count, na.rm = T)) %>% 
  ungroup() %>%  
  mutate(stream = "sacramento river",
         site = "knights landing",
         subsite = tolower(subsite),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) %>% glimpse()

filter(knights_landing_pre2006, species == "Steelhead", count > 0)
filter(knights_landing_pre2006, species == "Chinook", is.na(at_capture_run), count > 0)
filter(knights_landing_pre2006, date < "2006-10-02", lifestage == "older juvenile", count > 0)

knights_rst_clean_pre2006 <- knights_landing_pre2006 %>% 
  # filter to only include data before 2006 (CAMP stores data 2006 to present)
  filter(date < "2006-10-02") %>% 
  select(-c(start_date, stop_date, location, fork_length_max_mm, fork_length_min_mm, cpue)) %>% 
  rename(run = at_capture_run,
         adipose_clipped = marked) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         subsite = "knights landing", # data not disaggregated by trap
         # this likely happened from reshaping of data
         remove = case_when(is.na(run) & species == "Chinook" & count == 0 ~ "remove",
                            T ~ "keep")) %>% 
  filter(remove != "remove") %>% 
  select(-remove) %>% 
  group_by(date, species, run, lifestage, adipose_clipped, subsite) %>% 
  summarise(count = sum(count)) %>% glimpse()


knights_rst_clean_pre2002 <- knights_landing_pre2002 %>% 
  # there is one missing date that should be removed
  filter(!is.na(date)) %>% 
  # no count column so assume 1
  mutate(count = 1,
         trapid = ifelse(is.na(trapid), "knights landing", trapid),
         species = "chinook") %>% 
  rename(subsite = trapid,
         fork_length = fl,
         weight = ww,
         adipose_clipped = adipose_clip,
         dead = mort) %>% 
  # filter includes only fish that were unmarked (is.na or mark == F) or if the date was between 1996-11-24 and 1997-10-03 because the fish that were marked TRUE in this time period may be fish caught in trap for first time
  filter((is.na(mark) | mark == F | (mark == T & date >= "1996-11-24" & date <= "1997-10-03"))) %>% 
  group_by(date, subsite, fork_length, weight, lifestage, run, adipose_clipped, dead) %>% 
  summarize(count = sum(count)) %>% 
  ungroup()

knights_rst_clean <- bind_rows(knights_rst_clean_camp,
                           knights_rst_clean_pre2006,
                           knights_rst_clean_pre2002) 

knights_rst_min <- knights_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date)) 

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

# visitTime = visitTime2
filter(knights_effort, visitTime != visitTime2)

knights_trap_clean_camp <- knights_effort %>%
  # use sample date because this is the date the trap would have been checked
  select(visitTime, subSiteName) %>% 
  rename(date = visitTime,
         subsite = subSiteName) %>% 
  distinct() %>% 
  mutate(subsite = as.character(subsite))

knights_trap_pre2006 <- knights_effort_pre2006 %>% 
  # filter to only include data before 2006 (CAMP stores data 2006 to present)
  filter(date < "2006-10-02") %>% 
  select(date) %>% 
  distinct() %>% 
  mutate(subsite = "knights landing")

knights_trap_pre2002 <- knight_effort_pre2002 %>% 
  select(date, trapid) %>% 
  rename(subsite = trapid) %>% 
  mutate(subsite = ifelse(is.na(subsite), "knights landing", subsite)) %>% 
  distinct()

knights_trap_clean <- bind_rows(knights_trap_clean_camp, knights_trap_pre2006, knights_trap_pre2002)

knights_trap_min <- knights_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
knights_min_date_compare <- full_join(knights_rst_min, knights_trap_min)

# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
knights_rst_clean_final <- full_join(knights_rst_clean, 
                                    knights_trap_clean) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "sacramento river",
         site = "knights landing",
         date = as_date(date),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         run_method = tolower(run_method),
         species = tolower(species),
         species = ifelse(species == "chinook", "chinook salmon", species),
         lifestage = tolower(lifestage),
         run = tolower(run)) 
# THIS CODE MODIFIES knights_clean_final using functions that
# mutate using data.table package
setDT(knights_rst_clean_final)
knights_rst_clean_final %>% 
  run_encoding_dt() %>% 
  run_method_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- catchRawID, trapVisitID, lifeStageCAMPID removed because outside of CAMP this doesn't link well
- visitTime2 is typically the same as visitTime and is included in effort table
- visitType is included in operations table


## Lower Sacramento - Tisdale

```{r, tisdale_data_dictionary}
tisdale_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                               "data-dictionaries", "lower_sac_tisdale_rst_data_dictionary.rds"))
kable(tisdale_data_dictionary)
```

```{r, tisdale_clean}
tisdale_rst %>% glimpse
tisdale_rst_camp %>% glimpse
# same dates for the excel sheets vs CAMP so use CAMP
min(tisdale_rst$date)
min(tisdale_rst_camp$visitTime)
# many obs where run is NA
unique(tisdale_rst_camp$run)
#filter(tisdale_rst_camp, is.na(run), commonName == "Chinook salmon", n >0)
unique(tisdale_rst_camp$commonName)
unique(tisdale_rst_camp$fishOrigin)
unique(tisdale_rst_camp$markType)
filter(tisdale_rst_camp, visitTime != visitTime2)
tisdale_rst_clean <- tisdale_rst_camp %>%
  # removing existing mark for now. will add all those in later
  select(-c(catchRawID, trapVisitID, visitTime2, visitType, markCode_1, markType_1, markColor_1, markPosition_1)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         lifestage = lifeStage,
         date = visitTime,
         run_method = runMethod, 
         subsite = subSiteName,
         release_id = releaseID,
         dead = mort) %>%
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped, run_method, stream, site, subsite, release_id,) %>%
  summarize(count = sum(n, na.rm = T)) %>%
  ungroup() %>% 
  mutate(subsite = tolower(subsite),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) 

tisdale_rst_min <- tisdale_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

tisdale_trap_clean <- tisdale_trap_camp %>%
  rename(date = visitTime) %>%
  distinct()

tisdale_trap_min <- tisdale_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
# no difference for tisdale
tisdale_min_date_compare <- full_join(tisdale_rst_min, tisdale_trap_min)

setDT(tisdale_rst_clean)
tisdale_rst_clean %>% 
  run_encoding_dt() %>% 
  run_method_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- fish_processed: included in operations table
- run is a combination of at_capture_run and final_run (replaces at_capture_run with final_run when final_run exists)
- release_id is an ID column from CAMP and doesn't link well outside of CAMP
- mark_type, mark_position, mark_color removed because little information (35 obs) and rearing includes the fin clip marking

# Standard format {.tabset}

## River Length At Date

Process LAD to find range of fork lengths assigned to run on given day

```{r}
lad_spring <- filter(lad, LENGTHRUN == "S") %>%
  rename(s_start = STARTFL,
         s_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_spring_2 <- filter(lad_spring, count > 1) %>% 
  slice_min(s_start) %>%
  rename(s_start_1 = s_start,
         s_end_1 = s_end) %>%
  left_join(filter(lad_spring, count > 1) %>% 
  slice_max(s_start) %>%
  rename(s_start_2 = s_start,
         s_end_2 = s_end)) %>%
  select(-count)
lad_spring_format <- filter(lad_spring, count == 1) %>%
  select(-count) %>%
  rename(s_start_1 = s_start,
         s_end_1 = s_end) %>%
  bind_rows(lad_spring_2)

# Format fall run. There may be multiple criteria for one date
lad_fall <- filter(lad, LENGTHRUN == "F") %>%
  rename(f_start = STARTFL,
         f_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_fall_2 <- filter(lad_fall, count > 1) %>% 
  slice_min(f_start) %>%
  rename(f_start_1 = f_start,
         f_end_1 = f_end) %>%
  left_join(filter(lad_fall, count > 1) %>% 
  slice_max(f_start) %>%
  rename(f_start_2 = f_start,
         f_end_2 = f_end)) %>%
  select(-count)
lad_fall_format <- filter(lad_fall, count == 1) %>%
  select(-count) %>%
  rename(f_start_1 = f_start,
         f_end_1 = f_end) %>%
  bind_rows(lad_fall_2)

# Format winter run. There may be multiple criteria for one date.
lad_winter <- filter(lad, LENGTHRUN == "W") %>%
  rename(w_start = STARTFL,
         w_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_winter_2 <- filter(lad_winter, count > 1) %>% 
  slice_min(w_start) %>%
  rename(w_start_1 = w_start,
         w_end_1 = w_end) %>%
  left_join(filter(lad_winter, count > 1) %>% 
  slice_max(w_start) %>%
  rename(w_start_2 = w_start,
         w_end_2 = w_end)) %>%
  select(-count)
lad_winter_format <- filter(lad_winter, count == 1) %>%
  select(-count) %>%
  rename(w_start_1 = w_start,
         w_end_1 = w_end) %>%
  bind_rows(lad_winter_2)

# Format late fall run. There may be multiple criteria for one date.
lad_latefall <- filter(lad, LENGTHRUN == "L") %>%
  rename(l_start = STARTFL,
         l_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_latefall_2 <- filter(lad_latefall, count > 1) %>% 
  slice_min(l_start) %>%
  rename(l_start_1 = l_start,
         l_end_1 = l_end) %>%
  left_join(filter(lad_latefall, count > 1) %>% 
  slice_max(l_start) %>%
  rename(l_start_2 = l_start,
         l_end_2 = l_end)) %>%
  select(-count)
lad_latefall_format <- filter(lad_latefall, count == 1) %>%
  select(-count) %>%
  rename(l_start_1 = l_start,
         l_end_1 = l_end) %>%
  bind_rows(lad_latefall_2)

lad_format <- full_join(lad_spring_format, lad_fall_format) %>%
  full_join(lad_winter_format) %>%
  full_join(lad_latefall_format) %>%
  rename(month = SAMPLEMONTH,
         day = SAMPLEDAY)
```

```{r, combined}
# TODO fill in run method - this will involve outreach with monitoring programs
# improve performance by using data.table
#2126829
combined_rst <- bind_rows(battle_clear_rst_clean_final,
                          butte_rst_clean,
                          deer_rst_clean_combined,
                          feather_rst_clean,
                          mill_rst_clean_combined,
                          yuba_rst_clean,
                          knights_rst_clean_final,
                          tisdale_rst_clean,
                          rbdd_rst) %>% 
  as_tibble() %>% 
  mutate(date = as.Date(date),
         month = month(date), # add to join with lad and yearling
         day = day(date)) %>% # add to join with lad and yearling
  left_join(daily_yearling_ruleset) |> 
  left_join(lad_format) %>% 
  # include run_lad_rivermodel but don't apply because doesn't work for mill/deer and others
  mutate(run_lad_rivermodel = case_when((fork_length >= s_start_1 & fork_length < s_end_1) |
                                      (fork_length >= s_start_2 & fork_length < s_end_2) ~ "spring",
                                    (fork_length >= f_start_1 & fork_length < f_end_1) |
                                      (fork_length >= f_start_2 & fork_length < f_end_2) ~ "fall",
                                    (fork_length >= w_start_1 & fork_length < w_end_1) |
                                      (fork_length >= w_start_2 & fork_length < w_end_2) ~ "winter",
                                    (fork_length >= l_start_1 & fork_length < l_end_1) |
                                      (fork_length >= l_start_2 & fork_length < l_end_2) ~ "late fall"),
         #run = ifelse(run == "not recorded", run_lad_rivermodel, run),
         #run_method = ifelse(run == "not recorded", "length-at-date criteria", run_method),
         species = ifelse(is.na(species), "chinook salmon", species),
         count = ifelse(count == 0 & !is.na(fork_length), 1, count), # add handeling for when count is 0 but fl specified, confirmed cound 0 in fieldsheets
         is_yearling = case_when(fork_length <= cutoff & !run %in% c("fall","late fall", "winter") ~ F,
                                 fork_length > cutoff & !run %in% c("fall","late fall", "winter") ~ T,
                                 run %in% c("fall","late fall", "winter") ~ NA,
                                 T ~ NA),
         lifestage = ifelse(lifestage == "sac fry", "yolk sac fry", lifestage)) %>% # few cases primarily from pre 2002 Sac that are species are NA
  select(date, run, fork_length, lifestage, dead, interpolated, count, stream, site_group, site, subsite, adipose_clipped, run_method, species, release_id, weight, is_yearling)

unique(combined_rst$run)
unique(combined_rst$lifestage)
unique(combined_rst$site)
unique(combined_rst$stream)
```

## Data dictionary

```{r, data_dictionary_prep, include = F}
colnames(combined_rst)

rst_catch_data_dictionary <- tibble(variable_name = colnames(combined_rst),
                                    description = c("Date trap was checked.",
                                                    "Designated run of fish using method in run_method. Some locations did not designate a run; in these cases the river model length at date criteria were applied. NA when count is 0.",
                                                    "Fork length of fish in mm.",
                                                    "Life stage of fish. NA when count is 0.",
                                                    "Describes if fish were dead when observed (T/F).",
                                                    "Describes if data were interpolated (T/F).",
                                                    "Number of fish caught.",
                                                    "Mainstem/tributary location of trap.",
                                                    "Site group is used for Feather River to denote if the site is in the High Flow Channel (hfc) or Low Flow Channel (lfc)",
                                                    "Site of trap within location. Some locations do not have multiples sites in which stream = site. Site names are specific to the tributary.",
                                                    "Name of trap where fish were caught.",
                                                    "Describes if adipose fin is clipped (T/F). This is used to determine if the fish is natural or hatchery origin. In some cases this information may be unknown.",
                                                    "Method used to designate run. NA if count is 0.",
                                                    "Species of fish.",
                                                    "Release group that recaptured fish is part of. If fish is not a recaptured fish, release_id is NA.",
                                                    "Weight in grams.",
                                                    "If fish is yearling based on yearling ruleset (T/F)"
                                                    ),
                                    
                                    encoding = c(NA,
                                                 "late fall, spring, fall, winter, not recorded, unknown",
                                                 NA,
                                                 "smolt, fry, yolk sac fry, not recorded, parr, silvery parr, adult, unknown, yearling",
                                                 "TRUE, FALSE",
                                                 "TRUE, FALSE",
                                                 NA,
                                                 "battle creek, butte creek, clear creek, deer creek, feather river, mill creek, yuba river, sacramento river",
                                                 "feather hfc, feather lfc",
                                                 "battle creek, okie dam, adams dam, lcc, ucc, deer creek, eye riffle, live oak, herringer riffle, steep riffle, sunset pumps, shawns beach, gateway riffle, mill creek, yuba river, hallwood, knights landing, tisdale, red bluff diversion dam",
                                                 "see readme",
                                                 "TRUE, FALSE",
                                                 "not recorded, length-at-date criteria, appearance, hatchery attribute",
                                                 "chinook salmon as well as other species caught in trap",
                                                 "NA if not recapture fish",
                                                 NA,
                                                 "TRUE, FALSE"
                                                 ),
                                    collected = c("All",
                                                       "All but Deer, Mill",
                                                       "All",
                                                       "All but Deer, Mill",
                                                       "All but Deer, Mill, Yuba",
                                                       "Battle, Clear",
                                                       "All",
                                                       "All",
                                                  "Feather",
                                                       "All",
                                                       "All",
                                                       "Butte, Feather, Knights, Tisdale",
                                                       "Battle, Clear, Feather, Knights, Tisdale",
                                                       "Feather, Knights, Tisdale",
                                                  "Battle, Clear, Feather, Knights, Tisdale",
                                                       "Butte, Deer, Feather, Knights, Tisdale, Yuba",
                                                  "All"))
```

```{r, data_dictionary}
kable(rst_catch_data_dictionary)
# write_csv(rst_catch_data_dictionary, "rst_catch_data_dictionary.csv")
```

## Exploratory plots

Boxplots of lifestage and fork length to verify lifestage encodings

```{r}
ggplot(combined_rst, aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Yolk sac fry categories

```{r}
# check category mappings
# yolk sac fry
ggplot(filter(combined_rst, lifestage %in% c("yolk-sac fry", "yolk sac fry (alevin)", "yolk sac fry")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Silvery fry categories 

Fingerling and pre-smolt added to silvery parr because of similar fork lengths.

```{r}
# silvery parr
ggplot(filter(combined_rst, lifestage %in% c("silvery parr", "fingerling", "pre-smolt")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Juvenile and unknown

Only one "yoy (young of the year)" and two juvenile. These are added to unknown (there is 1 unknown).

```{r}
# unknown
ggplot(filter(combined_rst, lifestage %in% c("unknown", "yoy (young of the year)", "juvenile")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))

filter(combined_rst, lifestage == "yoy (young of the year)") %>% tally()
filter(combined_rst, lifestage == "juvenile") %>% tally()
filter(combined_rst, lifestage == "unknown") %>% tally()
```

Parr

Pre-smolt fits better with silvery parr

```{r}
# parr
ggplot(filter(combined_rst, lifestage %in% c("parr", "pre-smolt")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Fry

Button up fry and fry are similar fork lengths

```{r}
# fry
ggplot(filter(combined_rst,  lifestage %in% c("fry", "button-up fry", "fry (button-up)")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```


# QA/QC {.tabset}

## run

Run is not recorded for Mill and Deer. Butte only has spring run.

Figure below shows the percentage by run for each tributary and year.

```{r, run_qaqc}
unique(combined_rst$run)

total_count <- combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(site, year) %>%
  summarize(total = sum(count, na.rm = T))

combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(site, year, run) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = run)) +
  geom_col() +
  facet_wrap(~site, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## fork_length

Figure below shows the percent of total fish counted that have a fork length measurement.

```{r, forklength_qaqc}
combined_rst %>%
  filter(!is.na(fork_length)) %>%
  mutate(year = year(date)) %>%
  group_by(site, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~site)
  
```

## lifestage

Deer and Mill do not recored lifestage. Data is spotty for Butte and Yuba.

Figure below shows the percentage by lifestage for each tributary and year.

```{r, lifestage_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(site, year, lifestage) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = lifestage)) +
  geom_col() +
  facet_wrap(~site, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```
## count

Note that there are 72 observations for Mill Creek where count is NA. Count could be 0, 1, or more than 1. 

```{r, count_qaqc}
filter(combined_rst, is.na(count)) %>% glimpse()
```

## dead

Figure below shows percent of fish observed that were marked as dead. Note that some
locations do not record this information.

```{r, dead_qaqc}
combined_rst %>%
  filter(dead == T) %>%
  mutate(year = year(date)) %>%
  group_by(site, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~site)
```

## interpolated

Battle and Clear include interpolated values.

Figure below shows percent of fish observed that were interpolated. Interpolated
counts do not include values for fork length.

```{r, interpolated_qaqc}
combined_rst %>%
  filter(interpolated == T) %>%
  mutate(year = year(date)) %>%
  group_by(site, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~site)

combined_rst %>%
  filter(stream %in% c("battle creek", "clear creek")) %>%
  group_by(stream, date, interpolated) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  ggplot(aes(x = date, y = count, color = interpolated)) +
  geom_line() +
  facet_wrap(~stream, scales = "free_y")
```

## adipose_clipped

Origin is mostly natural. Only Butte Creek, Knights Landing, Tisdale included data
for origin. For other locations it is not relevant or was already filtered.

```{r, origin_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(site, year, adipose_clipped) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = adipose_clipped)) +
  geom_col() +
  facet_wrap(~site, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## weight

Figure below shows the percent of total fish counted that have a weight measurement.

```{r, weight_qaqc}
combined_rst %>%
  filter(!is.na(weight)) %>%
  mutate(year = year(date)) %>%
  group_by(site, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~site)
```
## run_method

Only Knights Landing recorded this information. Method is assumed to be length-at-date
for all others. 

```{r, runmethod_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(site, year, run_method) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = run_method)) +
  geom_col() +
  facet_wrap(~site, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r, include = F}
check_dates <- function(dat) {
  dat |> 
    group_by(stream, site, subsite) |> 
    summarize(min_date = min(date),
              max_date = max(date))
}

combined_rst |> 
  check_dates() |> 
  view()

```


# Save data

```{r, save_data}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(combined_rst,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_rst_catch_051525.csv",
           predefinedAcl = "bucketLevel")
```
